{include="header"}

{if="$fsc->url_recarga!=''"}
<script type="text/javascript">
   $(document).ready(function() {
      setTimeout(function(){ window.location.href = '{$fsc->url_recarga}'; }, 1000);
   });
</script>
{/if}

<script type="text/javascript">
   function recalcular()
   {
      // Variable que va a ir acumulando el precio total de los artículos
      var totalFilas = 0;
      
      // Variable que almacena el número de filas del carrito
      var totalNumFilas = 0;
      
      // Recorremos todas las filas del carrito
      $("tr[id^='fila']").each(function(){
         // Obtenemos el ID de la fila que está en el atributo "id" compuesto de "fila_numero"
         var filaId = $(this)[0].getAttribute('id').split("_")[1];
         
         // Calculamos el precio con respecto la cantidad deseada y el descuento
         var precioTotalFila = $("input[name='cantidad_"+filaId+"']").val()
                 * $("input[name='precio_"+filaId+"']").val()
                 * (100-$("input[name='descuento_"+filaId+"']").val())/100;
         
         // Modificamos el precio de la fila
         $("#preciototal_"+filaId).text( show_precio(precioTotalFila) );
         
         // Añadimos al acumulado
         totalFilas += precioTotalFila;
         
         totalNumFilas++;
      });
      
      // Tras el bucle modificamos el precio total de los artículos y el número de filas
      $("#total_filas").text( show_precio(totalFilas) );
      $("#total_filas_carrito.badge").text(totalNumFilas);
      $("#filascarrito").val(totalNumFilas);
   }
   $(document).ready(function() {
      recalcular();
      
      if(window.location.hash.substring(1) === 'carrito')
      {
         $('.nav-tabs a[href="#carrito"]').tab('show');
      }
      else if(window.location.hash.substring(1) === 'opciones')
      {
         $('.nav-tabs a[href="#opciones"]').tab('show');
      }
   });
</script>

<div class="container-fluid">
   <div class="row">
      <div class="col-sm-12">
         <div class="page-header">
            <h1>
               <span class="glyphicon glyphicon-shopping-cart"></span>
               Comprar artículos
               <span class="btn-group">
                  <a class="btn btn-xs btn-default" href="{$fsc->url()}" title="Recargar la página">
                     <span class="glyphicon glyphicon-refresh"></span>
                  </a>
                  {if="$fsc->page->is_default()"}
                  <a class="btn btn-xs btn-default active" href="{$fsc->url()}&amp;default_page=FALSE" title="Marcada como página de inicio (pulsa de nuevo para desmarcar)">
                     <i class="fa fa-bookmark" aria-hidden="true"></i>
                  </a>
                  {else}
                  <a class="btn btn-xs btn-default" href="{$fsc->url()}&amp;default_page=TRUE" title="Marcar como página de inicio">
                     <i class="fa fa-bookmark-o" aria-hidden="true"></i>
                  </a>
                  {/if}
               </span>
               <span class="btn-group">
                  <a href="index.php?page=importador_articulos_csv" class="btn btn-xs btn-default">
                     <span class="glyphicon glyphicon-import"></span>
                     <span class="hidden-xs">&nbsp;Importar</span>
                  </a>
                  {loop="$fsc->extensions"}
                     {if="$value->type=='button'"}
                     <a href="index.php?page={$value->from}{$value->params}" class="btn btn-xs btn-default">{$value->text}</a>
                     {/if}
                  {/loop}
               </span>
            </h1>
            <p class="help-block">
               Aquí tienes el listado de los artículos que puedes comprar a tus <b>proveedores</b>.
               Puedes comparar precios o incluso <b>crear pedidos</b> como si fuese una tienda online.
            </p>
         </div>
      </div>
   </div>
   <form action="{$fsc->url()}" method="post" class="form">
      <div class="row">
         <div class="col-sm-3">
            <div class="input-group">
               <input class="form-control" type="text" name="query" value="{$fsc->query}" autocomplete="off" placeholder="Buscar" autofocus/>
               <span class="input-group-btn">
                  <button class="btn btn-primary hidden-sm" type="submit">
                     <span class="glyphicon glyphicon-search"></span>
                  </button>
               </span>
            </div>
         </div>
         <div class="col-sm-3">
            <select name="codproveedor" class="form-control" onchange="this.form.submit()">
               <option value="">Cualquier proveedor</option>
               <option value="">------</option>
               {loop="$fsc->proveedores"}
                  {if="$value->acreedor"}
                  {elseif="$value->codproveedor==$fsc->codproveedor"}
                  <option value="{$value->codproveedor}" selected="">{$value->nombre}</option>
                  {else}
                  <option value="{$value->codproveedor}">{$value->nombre}</option>
                  {/if}
               {/loop}
            </select>
         </div>
         <div class="col-sm-3">
            <div class="checkbox">
               <label>
                  {if="$fsc->constock"}
                  <input type="checkbox" name="constock" value="TRUE" checked="" onchange="this.form.submit()"/>
                  {else}
                  <input type="checkbox" name="constock" value="TRUE" onchange="this.form.submit()"/>
                  {/if}
                  Con stock
               </label>
            </div>
         </div>
         <div class="col-sm-3">
            <div class="input-group">
               <span class="input-group-addon">
                  <span class="glyphicon glyphicon-sort-by-attributes-alt"></span>
               </span>
               <select name="orden" class="form-control" onchange="this.form.submit()">
                  <option value="pvpmin"{if="$fsc->orden=='pvpmin'"} selected=""{/if}>Ordenar por menor precio</option>
                  <option value="pvpmax"{if="$fsc->orden=='pvpmax'"} selected=""{/if}>Ordenar por mayor precio</option>
                  <option value="stockmax"{if="$fsc->orden=='stockmax'"} selected=""{/if}>Ordenar por mayor stock</option>
                  <option value="referencia"{if="$fsc->orden=='referencia'"} selected=""{/if}>Ordenar por referencia</option>
               </select>
            </div>
         </div>
      </div>
   </form>
</div>
<br/>
<div>
   <ul class="nav nav-tabs" role="tablist">
      <li role="presentation"{if="$fsc->mostrar=='resultados'"} class="active"{/if}>
         <a href="#resultados" aria-controls="resultados" role="tab" data-toggle="tab">
            <span class="glyphicon glyphicon-search"></span>
            <span class="hidden-xs">&nbsp;Resultados</span>
            <span class="badge">{$fsc->total_resultados}</span>
         </a>
      </li>
      <li role="presentation"{if="$fsc->mostrar=='carrito'"} class="active"{/if}>
         <a href="#carrito" aria-controls="carrito" role="tab" data-toggle="tab">
            <span class="glyphicon glyphicon-shopping-cart"></span>
            <span class="hidden-xs">&nbsp;Carrito</span>
            <span id="total_filas_carrito" class="badge">{function="count($fsc->filas_carrito)"}</span>
         </a>
      </li>
      <li role="presentation">
         <a href="#opciones" aria-controls="opciones" role="tab" data-toggle="tab" title="Opciones">
            <span class="glyphicon glyphicon-wrench"></span>
            <span class="hidden-xs">&nbsp;Opciones</span>
         </a>
      </li>
   </ul>
   <div class="tab-content">
      <div role="tabpanel" class="tab-pane{if="$fsc->mostrar=='resultados'"} active{/if}" id="resultados">
         <div class="table-responsive">
            <table class="table table-hover">
               <thead>
                  <tr>
                     <th>Proveedor</th>
                     <th>Ref. Proveedor + Partnumber</th>
                     <th>Referencia</th>
                     <th></th>
                     <th>Descripción</th>
                     <th class="text-right">Precio</th>
                     <th>Dto.</th>
                     <th class="text-right">Total+{#FS_IVA#}</th>
                     <th></th>
                     <th class="text-right">Stock</th>
                  </tr>
               </thead>
               {loop="$fsc->resultados"}
               <tr>
                  <td><a href="{$value->url_proveedor()}">{$fsc->get_nombre_proveedor($value->codproveedor)}</a></td>
                  <td>{$value->refproveedor} {$value->partnumber}</td>
                  <td>
                     {if="$value->get_articulo()"}
                     <a href="index.php?page=ventas_articulo&ref={$value->referencia}">{$value->referencia}</a>
                     {else}
                     {$value->referencia}
                     <a href="{$fsc->url()}&nuevo={$value->id}">
                        <span class="glyphicon glyphicon-plus-sign" title="Añadir a nuestro catálogo"></span>
                     </a>
                     {/if}
                  </td>
                  <td class="text-right">
                     <a href="#" title="Editar" data-toggle="modal" data-target="#editar_ap{$value->id}">
                        <span class="glyphicon glyphicon-edit"></span>
                     </a>
                  </td>
                  <td>{$value->descripcion}</td>
                  <td class='text-right{if="$value->precio<=0"} warning{/if}'>{$fsc->show_precio($value->precio)}</td>
                  <td>{if="$value->dto==0"}-{else}{$fsc->show_numero($value->dto)} %{/if}</td>
                  <td class='text-right{if="$value->total_iva()<=0"} warning{/if}'>{$fsc->show_precio($value->total_iva())}</td>
                  <td>    
                     <a href="index.php?page=compras_articulos&carrito=add&id={$value->id}" title="Añadir al carrito">
                        <span class="glyphicon glyphicon-shopping-cart"></span>
                     </a>
                  </td>
                  <td class='text-right{if="$value->nostock OR $value->stock>0"} success{else} warning{/if}'>{if="$value->nostock"}-{else}{$value->stock}{/if}</td>
               </tr>
               {else}
               <tr><td colspan="10" class="warning">Sin resultados.</td></tr>
               {/loop}
            </table>
         </div>
         <div class="text-center">
            <ul class="pagination">
               {loop="$fsc->paginas()"}
               <li{if="$value['actual']"} class="active"{/if}>
                  <a href="{$value['url']}">{$value['num']}</a>
               </li>
               {/loop}
            </ul>
         </div>
      </div>
      <div role="tabpanel" class="tab-pane{if="$fsc->mostrar=='carrito'"} active{/if}" id="carrito">
         <div class="container-fluid" style="margin-top: 10px;">
            <div class="row">
               <div class="col-sm-12">
                  <p class="help-block">
                     Añade todos los artículos de los proveedores que quieras para
                     crear pedidos de compra.
                     Pulsa el icono
                     <span class="glyphicon glyphicon-shopping-cart"></span>
                     en cualquiera de los artículos de la pestaña resultados.
                     <b>No olvides</b> pulsar el botón guardar para que se guarden
                     los cambios en el carrito.
                  </p>
               </div>
            </div>
         </div>
         <form id="f_carrito" name="f_carrito" action="{$fsc->url()}#carrito" method="post">
            <input type="hidden" name="carrito" value="modificar"/>
            <input type="hidden" id="filascarrito" name="filascarrito" value="0"/>
            <input type="hidden" id="realizarpedido" name="realizarpedido" value="FALSE"/>
            <div class="table-responsive">
               <table class="table table-hover">
                  <thead>
                     <tr>
                        <th>Proveedor</th>
                        <th>Artículo</th>
                        <th class="text-right" width="150">Precio</th>
                        <th class="text-right" width="120">Cantidad</th>
                        <th width="60"></th>
                        <th class="text-right" width="120">Dto.</th>
                        <th class="text-right" width="150">Importe</th>
                     </tr>
                  </thead>
                  {loop="$fsc->filas_carrito"}
                  <tr id="fila_{$counter}">
                     <input type="hidden" name="idfila_{$counter}" value="{$value->id}"/>
                     <input type="hidden" name="idarticulopro_{$counter}" value="{$value->idarticulop}"/>
                     <input type="hidden" name="precio_{$counter}" value="{$value->articulop->precio}"/>
                     <input type="hidden" name="descuento_{$counter}" value="{$value->articulop->dto}"/>
                     <td><div class="form-control">{$fsc->get_nombre_proveedor($value->articulop->codproveedor)}</div></td>
                     <td><div class="form-control">{$value->articulop->descripcion}</div></td>
                     <td><div class="form-control text-right">{$fsc->show_precio($value->articulop->precio)}</div></td>
                     <td>
                        <input type="number" id="cantidad_{$counter}" class="form-control text-right" name="cantidad_{$counter}" value="{$value->cantidad}" onchange="recalcular()" onkeyup="recalcular()" autocomplete="off"/>
                     </td>
                     <td>
                        <button class="btn btn-sm btn-danger" type="button" onclick="$('#fila_{$counter}').remove();recalcular();">
                           <span class="glyphicon glyphicon-trash"></span>
                        </button>
                     </td>
                     <td><div class="form-control text-right">{$fsc->show_numero($value->articulop->dto)} %</div></td>
                     <td>
                        <div id="preciototal_{$counter}" class="form-control text-right">{$fsc->show_precio($value->articulop->precio*$value->cantidad)}</div>
                     </td>
                  </tr>
                  {else}
                  <tr class="warning">
                     <td colspan="8">No hay artículos añadidos al carrito.</td>
                  </tr>
                  {/loop}
                  {if="$fsc->filas_carrito"}
                  <tr class="info">
                     <td colspan="5"></td>
                     <td><div class="form-control text-right">Total</div></td>
                     <td><div id="total_filas" class="form-control text-right" style="font-weight: bold;"></div></td>
                  </tr>
                  {/if}
               </table>
            </div>
            {if="$fsc->filas_carrito"}
            <div class="container-fluid">
               <div class="row">
                  <div class="col-sm-4">
                     <button class="btn btn-sm btn-info" type="button" onclick="this.disabled=true;$('#realizarpedido').val('TRUE');this.form.submit();">
                        <span class="glyphicon glyphicon-shopping-cart"></span>
                        <span class="hidden-xs">&nbsp;Realizar pedido(s)</span>
                     </button>
                  </div>
                  <div class="col-sm-8 text-right">
                     <a href="{$fsc->url()}&carrito=limpiar#carrito" class="btn btn-sm btn-danger">
                        <span class="glyphicon glyphicon-trash"></span>
                        <span class="hidden-xs">&nbsp;Vaciar</span>
                     </a>
                     <div class="btn-group">
                        <a href="{$fsc->url()}&caca={$fsc->random_string(4)}#carrito" class="btn btn-sm btn-default">
                           <span class="glyphicon glyphicon-repeat"></span>
                           <span class="hidden-xs">&nbsp;Deshacer</span>
                        </a>
                        <button class="btn btn-sm btn-primary" type="button" onclick="this.disabled=true;this.form.submit();">
                           <span class="glyphicon glyphicon-floppy-disk"></span>
                           <span class="hidden-xs">&nbsp;Guardar</span>
                        </button>
                     </div>
                  </div>
               </div>
            </div>
            {/if}
         </form>
      </div>
      <div role="tabpanel" class="tab-pane" id="opciones">
         <br/>
         <div class="container-fluid">
            <div class="row">
               <form action="{$fsc->url()}#opciones" method="post" class="form">
                  <input type="hidden" name="opciones" value="TRUE"/>
                  <div class="col-sm-4 col-lg-3">
                     <div class="checkbox">
                        <label>
                           {if="$fsc->compras_setup['iecsv_artpedido']"}
                           <input type="checkbox" name="iecsv_artpedido" value="TRUE" checked=""/>
                           {else}
                           <input type="checkbox" name="iecsv_artpedido" value="TRUE"/>
                           {/if}
                           Al hacer pedido, si no existe el artículo, crearlo.
                        </label>
                     </div>
                     <p class="help-block">
                        <span class="glyphicon glyphicon-info-sign"></span>
                        &nbsp; Si tienes actuado el cron, puedes hacer uso de las
                        siguientes funciones extra.
                     </p>
                     <div class="checkbox">
                        <label>
                           {if="$fsc->compras_setup['iecsv_act_art']"}
                           <input type="checkbox" name="iecsv_act_art" value="TRUE" checked=""/>
                           {else}
                           <input type="checkbox" name="iecsv_act_art" value="TRUE"/>
                           {/if}
                           Usar los datos del proveedor para actualizar los artículos de tu catálogo
                        </label>
                     </div>
                     <div class="form-group">
                        <label>
                           {if="$fsc->compras_setup['iecsv_act_art_precios']"}
                           <input type="checkbox" name="iecsv_act_art_precios" value="TRUE" checked=""/>
                           {else}
                           <input type="checkbox" name="iecsv_act_art_precios" value="TRUE"/>
                           {/if}
                           Usar el precio del proveedor como:
                        </label>
                        <select name="iecsv_act_art_precio" class="form-control">
                           <option value="coste"{if="$fsc->compras_setup['iecsv_act_art_precio']=='coste'"} selected=""{/if}>Coste</option>
                           <option value="pvp"{if="$fsc->compras_setup['iecsv_act_art_precio']=='pvp'"} selected=""{/if}>Precio de venta</option>
                        </select>
                        <p class="help-block">En los artículos de tu catálogo</p>
                     </div>
                     <div class="form-group">
                        <label>
                           {if="$fsc->compras_setup['iecsv_act_art_stock']"}
                           <input type="checkbox" name="iecsv_act_art_stock" value="TRUE" checked=""/>
                           {else}
                           <input type="checkbox" name="iecsv_act_art_stock" value="TRUE"/>
                           {/if}
                           Usar el stock del provedor como stock de este almacén
                        </label>
                        <select name="iecsv_act_art_alm" class="form-control">
                        {loop="$fsc->almacen->all()"}
                           {if="$fsc->compras_setup['iecsv_act_art_alm'] == $value->codalmacen"}
                           <option value="{$value->codalmacen}" selected="">{$value->nombre}</option>
                           {else}
                           <option value="{$value->codalmacen}">{$value->nombre}</option>
                           {/if}
                        {/loop}
                        </select>
                     </div>
                     <button class="btn btn-sm btn-primary" type="submit" onclick="this.disabled = true;this.form.submit();">
                        <span class="glyphicon glyphicon-floppy-disk"></span>&nbsp; Guardar
                     </button>
                  </div>
               </form>
               <div class='col-sm-2 col-lg-3'></div>
               <div class="col-sm-6 col-lg-6">
                  <a href="{$fsc->url()}&megamod=refproveedor" class="btn btn-sm btn-default">
                     <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
                     &nbsp; Referencias de proveedor
                  </a>
                  <p class="help-block">
                     ¿Quieres poder buscar artículos en compras y ventas escribiendo la referencia del proveedor?
                     Pues pulsa el botón y se añadirá la referencia del proveedor al campo <b>equivalencia</b>
                     de cada artículo.
                  </p>
                  <br/>
                  <a href="{$fsc->url()}&megamod=onlyarticulos" class="btn btn-sm btn-danger">
                     <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                     &nbsp; Fuera de catálogo
                  </a>
                  <p class="help-block">
                     ¿Quieres eliminar los datos de todos los artículos de proveedor que <b>no están en tu catálogo</b>?
                     Pues pulsa el botón y se eliminarán todos los artículos de proveedor que no se correspondan
                     con alguno de tus artículos.
                  </p>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>

{loop="$fsc->resultados"}
<form action="{$fsc->url()}&editar={$value->id}" method="post" class="form">
   <input type="hidden" name="modificar" value="false"/>
   <div class="modal fade" id="editar_ap{$value->id}" tabindex="-1" role="dialog" aria-labelledby="editar" aria-hidden="true">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
               </button>
               <h4 class="modal-title">
                  <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> Editar artículo de proveedor
                  <p class="help-block">
                     Referencia del proveedor: <b>{$value->refproveedor}</b>,
                     Proveedor: <b>{$value->nombre_proveedor()}</b>
                  </p>
               </h4>
            </div>
            <div class="modal-body">
               <div class="form-group">
                  Referencia:
                  <input type="text" name="edit_referencia" value="{$value->referencia}" class="form-control" autocomplete="off"/>
               </div>
               <div class="form-group">
                  Descripción:
                  <input type="text" name="edit_descripcion" value="{$value->descripcion}" required="" class="form-control" autocomplete="off"/>
               </div>
            </div>
            <div class="modal-footer">
               <a href="{$fsc->url()}&delete={$value->id}" class="btn btn-sm btn-danger pull-left">
                  <span class="glyphicon glyphicon-trash"></span>&nbsp; Eliminar
               </a>
               <button type="button" class="btn btn-sm btn-primary" onclick="this.disabled = true;this.form.submit();">
                  <span class="glyphicon glyphicon-floppy-disk"></span>&nbsp; Guardar
               </button>
            </div>
         </div>
      </div>
   </div>
</form>
{/loop}

{include="footer"}